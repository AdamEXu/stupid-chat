<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>T3 Chat Ripoff</title>
        <style>
            /* Reset and base styles */
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
                    Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                background: #0f0f0f;
                min-height: 100vh;
                display: flex;
                color: #e5e5e5;
                overflow: hidden;
            }

            /* Sidebar styles */
            .sidebar {
                width: 260px;
                background: #1a1a1a;
                border-right: 1px solid #2a2a2a;
                display: flex;
                flex-direction: column;
                height: 100vh;
                overflow: hidden;
            }

            .sidebar-header {
                padding: 1rem;
                border-bottom: 1px solid #2a2a2a;
            }

            .logo {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                font-size: 1.2rem;
                font-weight: 600;
                color: #e5e5e5;
                margin-bottom: 1rem;
            }

            .logo::before {
                content: "ðŸ¤–";
                font-size: 1.5rem;
            }

            .new-chat-btn {
                width: 100%;
                padding: 0.75rem;
                background: #2a2a2a;
                color: #e5e5e5;
                border: 1px solid #3a3a3a;
                border-radius: 8px;
                font-size: 0.9rem;
                cursor: pointer;
                transition: all 0.2s ease;
                margin-bottom: 1rem;
            }

            .new-chat-btn:hover {
                background: #3a3a3a;
                border-color: #4a4a4a;
            }

            .sidebar-content {
                flex: 1;
                padding: 1rem;
                overflow-y: auto;
            }

            .api-section {
                margin-bottom: 1rem;
            }

            .api-section label {
                display: block;
                font-size: 0.85rem;
                color: #888;
                margin-bottom: 0.5rem;
            }

            .api-input {
                width: 100%;
                padding: 0.5rem 0.75rem;
                background: #2a2a2a;
                border: 1px solid #3a3a3a;
                border-radius: 6px;
                color: #e5e5e5;
                font-size: 0.85rem;
                margin-bottom: 0.5rem;
            }

            .api-input:focus {
                outline: none;
                border-color: #4a4a4a;
            }

            .save-key-btn {
                width: 100%;
                padding: 0.5rem;
                background: #4a9eff;
                color: white;
                border: none;
                border-radius: 6px;
                font-size: 0.85rem;
                cursor: pointer;
                transition: background-color 0.2s ease;
            }

            .save-key-btn:hover {
                background: #3a8eef;
            }

            .save-key-btn:disabled {
                background: #555;
                cursor: not-allowed;
            }

            /* Error message */
            .error-message {
                background: #4a1a1a;
                color: #ff6b6b;
                padding: 0.5rem;
                border-radius: 6px;
                margin-bottom: 1rem;
                font-size: 0.85rem;
                display: none;
            }

            /* Main content area */
            .main-content {
                flex: 1;
                display: flex;
                flex-direction: column;
                height: 100vh;
                position: relative;
            }

            .main-header {
                padding: 1rem;
                border-bottom: 1px solid #2a2a2a;
                display: flex;
                align-items: center;
                gap: 1rem;
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                z-index: 10;
                background: #0f0f0f;
            }

            .toggle-sidebar-btn {
                background: transparent;
                border: none;
                color: #888;
                cursor: pointer;
                padding: 0.5rem;
                border-radius: 4px;
                transition: all 0.2s ease;
            }

            .toggle-sidebar-btn:hover {
                background: #2a2a2a;
                color: #e5e5e5;
            }

            .toggle-sidebar-btn::before {
                content: "â˜°";
                font-size: 1.2rem;
            }

            .main-title {
                font-size: 1rem;
                color: #e5e5e5;
                font-weight: 500;
            }

            /* Chat messages area */
            .chat-messages {
                flex: 1;
                padding: 4rem 2rem 250px 2rem;
                overflow-y: auto;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                min-height: calc(100vh - 4rem);
                box-sizing: border-box;
            }

            /* Welcome screen */
            .welcome-screen {
                max-width: 600px;
                width: 100%;
            }

            .welcome-title {
                font-size: 2rem;
                font-weight: 600;
                color: #e5e5e5;
                margin-bottom: 2rem;
            }

            .sample-questions {
                display: flex;
                flex-direction: column;
                gap: 0.75rem;
                margin-bottom: 2rem;
            }

            .sample-question {
                padding: 0.75rem 1rem;
                background: #1a1a1a;
                border: 1px solid #2a2a2a;
                border-radius: 8px;
                color: #e5e5e5;
                cursor: pointer;
                transition: all 0.2s ease;
                text-align: left;
                font-size: 0.9rem;
            }

            .sample-question:hover {
                background: #2a2a2a;
                border-color: #3a3a3a;
            }

            /* Message bubbles for actual chat */
            .message {
                margin-bottom: 1rem;
                animation: fadeIn 0.3s ease-in;
                max-width: 100%;
                width: 100%;
                text-align: left;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .message.user {
                display: flex;
                justify-content: flex-end;
            }

            .message.assistant {
                display: flex;
                justify-content: flex-start;
            }

            .message-bubble {
                max-width: 80%;
                padding: 1rem 1.25rem;
                border-radius: 18px;
                word-wrap: break-word;
                line-height: 1.5;
            }

            .message.user .message-bubble {
                background: #4a9eff;
                color: white;
                border-bottom-right-radius: 6px;
            }

            .message.assistant .message-bubble {
                background: #1a1a1a;
                color: #e5e5e5;
                border: 1px solid #2a2a2a;
                border-bottom-left-radius: 6px;
            }

            /* Markdown styles for assistant messages */
            .message.assistant .message-bubble h1,
            .message.assistant .message-bubble h2,
            .message.assistant .message-bubble h3,
            .message.assistant .message-bubble h4,
            .message.assistant .message-bubble h5,
            .message.assistant .message-bubble h6 {
                margin: 0.5rem 0;
                color: #e5e5e5;
            }

            .message.assistant .message-bubble p {
                margin: 0.5rem 0;
                line-height: 1.6;
            }

            .message.assistant .message-bubble ul,
            .message.assistant .message-bubble ol {
                margin: 0.5rem 0;
                padding-left: 1.5rem;
            }

            .message.assistant .message-bubble li {
                margin: 0.25rem 0;
            }

            .message.assistant .message-bubble code {
                background: #2a2a2a;
                color: #4a9eff;
                padding: 0.2rem 0.4rem;
                border-radius: 4px;
                font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
                font-size: 0.9em;
            }

            .message.assistant .message-bubble pre {
                background: #2a2a2a;
                border: 1px solid #3a3a3a;
                border-radius: 8px;
                padding: 1rem;
                margin: 0.5rem 0;
                overflow-x: auto;
                font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
            }

            .message.assistant .message-bubble pre code {
                background: none;
                padding: 0;
                color: #e5e5e5;
            }

            .message.assistant .message-bubble blockquote {
                border-left: 4px solid #4a9eff;
                margin: 0.5rem 0;
                padding-left: 1rem;
                color: #ccc;
                font-style: italic;
            }

            .message.assistant .message-bubble strong {
                font-weight: 600;
                color: #fff;
            }

            .message.assistant .message-bubble em {
                font-style: italic;
                color: #ccc;
            }

            .message.assistant .message-bubble a {
                color: #4a9eff;
                text-decoration: none;
            }

            .message.assistant .message-bubble a:hover {
                text-decoration: underline;
            }

            .chat-active {
                align-items: flex-start;
                justify-content: flex-start;
                text-align: left;
                padding: 4rem 2rem 250px 2rem;
            }

            /* Input area - Fixed at bottom */
            .input-area {
                position: fixed;
                bottom: 0;
                left: 260px;
                right: 0;
                padding: 1rem 2rem 2rem;
                background: #0f0f0f;
                border-top: 1px solid #2a2a2a;
                z-index: 20;
            }

            .input-container {
                max-width: 800px;
                margin: 0 auto;
                position: relative;
            }

            .input-wrapper {
                position: relative;
                background: #1a1a1a;
                border: 1px solid #2a2a2a;
                border-radius: 12px;
                padding: 0.75rem;
                display: flex;
                align-items: flex-end;
                gap: 0.5rem;
            }

            .input-wrapper:focus-within {
                border-color: #4a4a4a;
            }

            .message-input {
                flex: 1;
                background: transparent;
                border: none;
                color: #e5e5e5;
                font-size: 1rem;
                font-family: inherit;
                resize: none;
                min-height: 24px;
                max-height: 200px;
                line-height: 1.5;
                padding: 0;
            }

            .message-input:focus {
                outline: none;
            }

            .message-input::placeholder {
                color: #888;
            }

            .input-controls {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                flex-shrink: 0;
            }

            .model-select {
                padding: 0.25rem 0.5rem;
                background: #2a2a2a;
                border: 1px solid #3a3a3a;
                border-radius: 6px;
                color: #e5e5e5;
                font-size: 0.8rem;
                cursor: pointer;
                max-width: 120px;
            }

            .model-select:focus {
                outline: none;
                border-color: #4a4a4a;
            }

            .send-btn {
                padding: 0.5rem;
                background: #4a9eff;
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                transition: background-color 0.2s ease;
                display: flex;
                align-items: center;
                justify-content: center;
                width: 32px;
                height: 32px;
                flex-shrink: 0;
            }

            .send-btn:hover:not(:disabled) {
                background: #3a8eef;
            }

            .send-btn:disabled {
                background: #555;
                cursor: not-allowed;
            }

            .send-btn::before {
                content: "â†‘";
                font-size: 1rem;
                font-weight: bold;
            }

            .input-hint {
                position: absolute;
                left: 0.75rem;
                bottom: -1.5rem;
                font-size: 0.75rem;
                color: #666;
            }

            /* Loading indicator */
            .loading {
                display: inline-block;
                width: 16px;
                height: 16px;
                border: 2px solid #333;
                border-top: 2px solid #4a9eff;
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }

            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }

            /* Responsive design */
            @media (max-width: 768px) {
                body {
                    flex-direction: column;
                }

                .sidebar {
                    width: 100%;
                    height: auto;
                    border-right: none;
                    border-bottom: 1px solid #2a2a2a;
                    position: fixed;
                    top: 0;
                    left: 0;
                    z-index: 30;
                    transform: translateX(-100%);
                    transition: transform 0.3s ease;
                }

                .sidebar:not(.hidden) {
                    transform: translateX(0);
                }

                .main-content {
                    margin-left: 0;
                }

                .main-header {
                    left: 0;
                }

                .input-area {
                    left: 0;
                    padding: 1rem;
                }

                .category-buttons {
                    grid-template-columns: repeat(2, 1fr);
                }

                .chat-messages {
                    padding: 4rem 1rem 200px 1rem;
                }
            }

            /* Accessibility improvements */
            .sr-only {
                position: absolute;
                width: 1px;
                height: 1px;
                padding: 0;
                margin: -1px;
                overflow: hidden;
                clip: rect(0, 0, 0, 0);
                white-space: nowrap;
                border: 0;
            }

            /* Focus indicators for keyboard navigation */
            button:focus,
            input:focus,
            select:focus,
            textarea:focus {
                outline: 2px solid #4a9eff;
                outline-offset: 2px;
            }

            /* Scrollbar styling */
            ::-webkit-scrollbar {
                width: 6px;
            }

            ::-webkit-scrollbar-track {
                background: #1a1a1a;
            }

            ::-webkit-scrollbar-thumb {
                background: #3a3a3a;
                border-radius: 3px;
            }

            ::-webkit-scrollbar-thumb:hover {
                background: #4a4a4a;
            }
        </style>
    </head>
    <body>
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">T3 Chat Ripoff</div>
                <button class="new-chat-btn" id="new-chat-btn">New Chat</button>
            </div>

            <div class="sidebar-content">
                <!-- API Key Input Section -->
                <div class="api-section">
                    <label for="api-key-input">OpenRouter API Key</label>
                    <input
                        type="password"
                        id="api-key-input"
                        class="api-input"
                        placeholder="Enter your API key..."
                        aria-label="OpenRouter API Key"
                    />
                    <button id="save-key-btn" class="save-key-btn">
                        Save Key
                    </button>
                </div>

                <!-- Error Message -->
                <div
                    id="error-message"
                    class="error-message"
                    role="alert"
                    aria-live="polite"
                ></div>
            </div>
        </aside>

        <!-- Main content area -->
        <main class="main-content">
            <header class="main-header">
                <button
                    class="toggle-sidebar-btn"
                    id="toggle-sidebar-btn"
                    aria-label="Toggle sidebar"
                ></button>
                <h1 class="main-title">T3 Chat Ripoff</h1>
            </header>

            <!-- Chat messages display area -->
            <div
                id="chat-messages"
                class="chat-messages"
                role="log"
                aria-live="polite"
                aria-label="Chat conversation"
            >
                <!-- Welcome screen -->
                <div class="welcome-screen" id="welcome-screen">
                    <h2 class="welcome-title">How can I help you?</h2>

                    <div class="sample-questions">
                        <button
                            class="sample-question"
                            data-question="How does AI work?"
                        >
                            How does AI work?
                        </button>
                        <button
                            class="sample-question"
                            data-question="Are black holes real?"
                        >
                            Are black holes real?
                        </button>
                        <button
                            class="sample-question"
                            data-question="How many Rs are in the word 'strawberry'?"
                        >
                            How many Rs are in the word "strawberry"?
                        </button>
                        <button
                            class="sample-question"
                            data-question="What is the meaning of life?"
                        >
                            What is the meaning of life?
                        </button>
                    </div>
                </div>
                <!-- Messages will be dynamically inserted here -->
            </div>
        </main>

        <!-- Message input area - Fixed at bottom -->
        <div class="input-area">
            <div class="input-container">
                <div class="input-wrapper">
                    <textarea
                        id="message-input"
                        class="message-input"
                        placeholder="Type your message here..."
                        aria-label="Type your message"
                        disabled
                        rows="1"
                    ></textarea>

                    <div class="input-controls">
                        <select
                            id="model-select"
                            class="model-select"
                            aria-label="Select AI Model"
                            disabled
                        >
                            <option value="">Loading...</option>
                        </select>

                        <button
                            id="send-btn"
                            class="send-btn"
                            disabled
                            aria-label="Send message"
                        ></button>
                    </div>
                </div>

                <div class="input-hint">
                    Press Enter to send, Shift + Enter for new line
                </div>
            </div>
        </div>

        <script>
            // Application state
            let apiKey = "";
            let selectedModel = "";
            let messages = [];
            let isLoading = false;
            let isChatActive = false;

            // DOM elements
            const sidebar = document.getElementById("sidebar");
            const toggleSidebarBtn =
                document.getElementById("toggle-sidebar-btn");
            const newChatBtn = document.getElementById("new-chat-btn");
            const apiKeyInput = document.getElementById("api-key-input");
            const saveKeyBtn = document.getElementById("save-key-btn");
            const modelSelect = document.getElementById("model-select");
            const errorMessage = document.getElementById("error-message");
            const chatMessages = document.getElementById("chat-messages");
            const welcomeScreen = document.getElementById("welcome-screen");
            const messageInput = document.getElementById("message-input");
            const sendBtn = document.getElementById("send-btn");

            // Initialize the application
            async function init() {
                try {
                    await loadModels();
                    setupEventListeners();
                } catch (error) {
                    showError(
                        "Failed to initialize application: " + error.message
                    );
                }
            }

            // Set up event listeners
            function setupEventListeners() {
                // Sidebar toggle
                toggleSidebarBtn.addEventListener("click", toggleSidebar);

                // New chat button
                newChatBtn.addEventListener("click", startNewChat);

                // API key save button
                saveKeyBtn.addEventListener("click", saveApiKey);

                // Enter key in API key input
                apiKeyInput.addEventListener("keypress", (e) => {
                    if (e.key === "Enter") {
                        saveApiKey();
                    }
                });

                // Model selection
                modelSelect.addEventListener("change", (e) => {
                    selectedModel = e.target.value;
                    updateInputState();
                });

                // Send message button
                sendBtn.addEventListener("click", sendMessage);

                // Enter key in message input (without Shift)
                messageInput.addEventListener("keypress", (e) => {
                    if (e.key === "Enter" && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });

                // Auto-resize textarea
                messageInput.addEventListener("input", (e) => {
                    updateInputState();
                    autoResizeTextarea(e.target);
                });

                // Sample question buttons
                document.addEventListener("click", (e) => {
                    if (e.target.classList.contains("sample-question")) {
                        const question = e.target.dataset.question;
                        if (question) {
                            messageInput.value = question;
                            updateInputState();
                            sendMessage();
                        }
                    }
                });
            }

            // Simple markdown parser
            function parseMarkdown(text) {
                // Escape HTML first
                text = text
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;");

                // Code blocks (```code```)
                text = text.replace(
                    /```([\s\S]*?)```/g,
                    "<pre><code>$1</code></pre>"
                );

                // Inline code (`code`)
                text = text.replace(/`([^`]+)`/g, "<code>$1</code>");

                // Bold (**text** or __text__)
                text = text.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
                text = text.replace(/__(.*?)__/g, "<strong>$1</strong>");

                // Italic (*text* or _text_)
                text = text.replace(/\*(.*?)\*/g, "<em>$1</em>");
                text = text.replace(/_(.*?)_/g, "<em>$1</em>");

                // Headers
                text = text.replace(/^### (.*$)/gm, "<h3>$1</h3>");
                text = text.replace(/^## (.*$)/gm, "<h2>$1</h2>");
                text = text.replace(/^# (.*$)/gm, "<h1>$1</h1>");

                // Links [text](url)
                text = text.replace(
                    /\[([^\]]+)\]\(([^)]+)\)/g,
                    '<a href="$2" target="_blank">$1</a>'
                );

                // Blockquotes
                text = text.replace(
                    /^> (.*$)/gm,
                    "<blockquote>$1</blockquote>"
                );

                // Unordered lists
                text = text.replace(/^\* (.*$)/gm, "<li>$1</li>");
                text = text.replace(/^- (.*$)/gm, "<li>$1</li>");
                text = text.replace(/(<li>.*<\/li>)/s, "<ul>$1</ul>");

                // Ordered lists
                text = text.replace(/^\d+\. (.*$)/gm, "<li>$1</li>");

                // Line breaks
                text = text.replace(/\n\n/g, "</p><p>");
                text = text.replace(/\n/g, "<br>");

                // Wrap in paragraphs
                if (text && !text.startsWith("<")) {
                    text = "<p>" + text + "</p>";
                }

                return text;
            }

            // Toggle sidebar visibility
            function toggleSidebar() {
                sidebar.classList.toggle("hidden");
            }

            // Start a new chat
            function startNewChat() {
                clearConversation();
                showWelcomeScreen();
            }

            // Auto-resize textarea
            function autoResizeTextarea(textarea) {
                textarea.style.height = "auto";
                textarea.style.height =
                    Math.min(textarea.scrollHeight, 200) + "px";
            }

            // Show welcome screen
            function showWelcomeScreen() {
                isChatActive = false;
                chatMessages.classList.remove("chat-active");
                const welcomeScreen = document.getElementById("welcome-screen");
                if (welcomeScreen) {
                    welcomeScreen.style.display = "block";
                }

                // Reset chat messages container styling for welcome screen
                chatMessages.style.alignItems = "center";
                chatMessages.style.justifyContent = "center";
                chatMessages.style.textAlign = "center";
                chatMessages.style.paddingBottom = "250px";
            }

            // Hide welcome screen and show chat
            function showChatInterface() {
                isChatActive = true;
                chatMessages.classList.add("chat-active");
                const welcomeScreen = document.getElementById("welcome-screen");
                if (welcomeScreen) {
                    welcomeScreen.style.display = "none";
                }

                // Update chat messages container for conversation view
                chatMessages.style.alignItems = "flex-start";
                chatMessages.style.justifyContent = "flex-start";
                chatMessages.style.textAlign = "left";
                chatMessages.style.paddingBottom = "250px";
            }

            // Load available models from OpenRouter
            async function loadModels() {
                try {
                    const response = await fetch(
                        "https://openrouter.ai/api/v1/models"
                    );

                    if (!response.ok) {
                        throw new Error(
                            `HTTP ${response.status}: ${response.statusText}`
                        );
                    }

                    const data = await response.json();

                    if (!data.data || !Array.isArray(data.data)) {
                        throw new Error(
                            "Invalid response format from models API"
                        );
                    }

                    populateModelSelect(data.data);
                } catch (error) {
                    console.error("Error loading models:", error);
                    showError(
                        "Failed to load models. Please check your internet connection and try again."
                    );

                    // Disable chat input if models can't be loaded
                    modelSelect.innerHTML =
                        '<option value="">Failed to load models</option>';
                    modelSelect.disabled = true;
                }
            }

            // Populate the model selector dropdown
            function populateModelSelect(models) {
                modelSelect.innerHTML =
                    '<option value="">Select a model...</option>';

                // Sort models by name for better UX
                const sortedModels = models.sort((a, b) =>
                    a.name.localeCompare(b.name)
                );

                sortedModels.forEach((model) => {
                    const option = document.createElement("option");
                    option.value = model.id;
                    option.textContent = model.name;
                    modelSelect.appendChild(option);
                });

                // Enable the selector and set Llama 3.3 70B Instruct (free) as default
                modelSelect.disabled = false;

                // Look for the specific free Llama 3.3 70B model
                const llamaModel = sortedModels.find(
                    (model) =>
                        model.id === "meta-llama/llama-3.3-70b-instruct:free" ||
                        model.id.includes("llama-3.3-70b-instruct:free") ||
                        (model.name.includes("Llama 3.3 70B Instruct") &&
                            model.name.includes("free"))
                );

                if (llamaModel) {
                    selectedModel = llamaModel.id;
                    modelSelect.value = selectedModel;
                } else if (sortedModels.length > 0) {
                    // Fallback to first model if Llama 3.3 70B free not found
                    selectedModel = sortedModels[0].id;
                    modelSelect.value = selectedModel;
                }

                updateInputState();
            }

            // Save the API key
            function saveApiKey() {
                const key = apiKeyInput.value.trim();

                if (!key) {
                    showError("Please enter a valid API key");
                    return;
                }

                apiKey = key;
                hideError();
                updateInputState();

                // Clear the input for security
                apiKeyInput.value = "";

                // Show success feedback
                saveKeyBtn.textContent = "Saved!";
                saveKeyBtn.style.background = "#38a169";

                setTimeout(() => {
                    saveKeyBtn.textContent = "Save Key";
                    saveKeyBtn.style.background = "#667eea";
                }, 2000);
            }

            // Update the state of input elements
            function updateInputState() {
                const hasApiKey = !!apiKey;
                const hasModel = !!selectedModel;
                const hasMessage = messageInput.value.trim().length > 0;
                const canSend =
                    hasApiKey && hasModel && hasMessage && !isLoading;

                messageInput.disabled = !hasApiKey || !hasModel;
                sendBtn.disabled = !canSend;

                // Update placeholder text
                if (!hasApiKey) {
                    messageInput.placeholder =
                        "Please save your API key first...";
                } else if (!hasModel) {
                    messageInput.placeholder = "Please select a model first...";
                } else {
                    messageInput.placeholder =
                        "Type your message here... (Press Enter to send, Shift+Enter for new line)";
                }
            }

            // Send a message
            async function sendMessage() {
                if (!apiKey) {
                    showError("Please save your API key first");
                    return;
                }

                if (!selectedModel) {
                    showError("Please select a model first");
                    return;
                }

                const messageText = messageInput.value.trim();
                if (!messageText) {
                    return;
                }

                // Switch to chat interface if showing welcome screen
                if (!isChatActive) {
                    showChatInterface();
                }

                // Add user message to conversation
                addMessage("user", messageText);
                messages.push({ role: "user", content: messageText });

                // Clear input and update state
                messageInput.value = "";
                messageInput.style.height = "auto";
                isLoading = true;
                updateInputState();

                // Add loading indicator for assistant response
                const assistantMessageId = addMessage("assistant", "");
                const assistantBubble = document.querySelector(
                    `[data-message-id="${assistantMessageId}"] .message-bubble`
                );
                assistantBubble.innerHTML = '<div class="loading"></div>';

                try {
                    await streamResponse(assistantBubble);
                } catch (error) {
                    console.error("Error sending message:", error);
                    assistantBubble.textContent =
                        "Sorry, I encountered an error. Please try again.";
                    showError("Failed to send message: " + error.message);
                } finally {
                    isLoading = false;
                    updateInputState();
                }
            }

            // Stream the response from OpenRouter
            async function streamResponse(assistantBubble) {
                const response = await fetch(
                    "https://openrouter.ai/api/v1/chat/completions",
                    {
                        method: "POST",
                        headers: {
                            Authorization: `Bearer ${apiKey}`,
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            model: selectedModel,
                            messages: messages,
                            temperature: 0.7,
                            max_tokens: 1024,
                            stream: true,
                        }),
                    }
                );

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(
                        errorData.error?.message ||
                            `HTTP ${response.status}: ${response.statusText}`
                    );
                }

                const reader = response.body?.getReader();
                if (!reader) {
                    throw new Error("Response body is not readable");
                }

                const decoder = new TextDecoder();
                let buffer = "";
                let assistantMessage = "";

                try {
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        // Append new chunk to buffer
                        buffer += decoder.decode(value, { stream: true });

                        // Process complete lines from buffer
                        while (true) {
                            const lineEnd = buffer.indexOf("\n");
                            if (lineEnd === -1) break;

                            const line = buffer.slice(0, lineEnd).trim();
                            buffer = buffer.slice(lineEnd + 1);

                            if (line.startsWith("data: ")) {
                                const data = line.slice(6);
                                if (data === "[DONE]") break;

                                try {
                                    const parsed = JSON.parse(data);
                                    const content =
                                        parsed.choices[0]?.delta?.content;
                                    if (content) {
                                        assistantMessage += content;
                                        assistantBubble.innerHTML =
                                            parseMarkdown(assistantMessage);
                                    }
                                } catch (e) {
                                    // Ignore invalid JSON chunks
                                    console.warn(
                                        "Failed to parse JSON chunk:",
                                        e
                                    );
                                }
                            }
                        }
                    }
                } finally {
                    reader.cancel();
                }

                // Add the complete assistant message to conversation history
                if (assistantMessage) {
                    messages.push({
                        role: "assistant",
                        content: assistantMessage,
                    });
                } else {
                    assistantBubble.textContent =
                        "No response received. Please try again.";
                }
            }

            // Add a message to the chat display
            function addMessage(role, content) {
                const messageId = Date.now() + Math.random();
                const messageDiv = document.createElement("div");
                messageDiv.className = `message ${role}`;
                messageDiv.setAttribute("data-message-id", messageId);

                const bubbleDiv = document.createElement("div");
                bubbleDiv.className = "message-bubble";
                bubbleDiv.textContent = content;

                messageDiv.appendChild(bubbleDiv);
                chatMessages.appendChild(messageDiv);

                // Auto-scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;

                return messageId;
            }

            // Clear the conversation
            function clearConversation() {
                messages = [];

                // Reset chat messages and show welcome screen
                chatMessages.innerHTML = `
                    <div class="welcome-screen" id="welcome-screen">
                        <h2 class="welcome-title">How can I help you?</h2>

                        <div class="sample-questions">
                            <button class="sample-question" data-question="How does AI work?">
                                How does AI work?
                            </button>
                            <button class="sample-question" data-question="Are black holes real?">
                                Are black holes real?
                            </button>
                            <button class="sample-question" data-question="How many Rs are in the word 'strawberry'?">
                                How many Rs are in the word "strawberry"?
                            </button>
                            <button class="sample-question" data-question="What is the meaning of life?">
                                What is the meaning of life?
                            </button>
                        </div>
                    </div>
                `;

                showWelcomeScreen();
                hideError();
            }

            // Show error message
            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.style.display = "block";
            }

            // Hide error message
            function hideError() {
                errorMessage.style.display = "none";
            }

            // Initialize the application when the page loads
            document.addEventListener("DOMContentLoaded", init);
        </script>
    </body>
</html>
